define(["hammer","dragdealer","base_ui_module","zeus_utils","zeus_constants"],function(e,t,n,i,o){var s=window.client,d=i.dom,l=n.subclass({constructor:function(e){n.prototype.constructor.call(this,e),View=window.View;var t=this;t._html='<div data-bolt-ui="volume-slider" class="bolt-volume-slider dragdealer"><div class="bolt-volume-slider-background"></div><div class="bolt-current-volume bolt-background"></div><div class="bolt-handle bolt-foreground"></div></div>',t._container=d.getUI(o.UI.VOLUME_CONTROL),t.soundBtn=d.getUI(o.UI.SOUND_BTN),t.soundBtnWidth=t.soundBtn.clientWidth,t._container.insertAdjacentHTML("beforeend",t._html),t._background=t._container.querySelector(".bolt-volume-slider-background"),t._handle=t._container.querySelector(".bolt-handle"),t._fill=t._container.querySelector(".bolt-current-volume"),t._fillMaxWidth=parseFloat(getComputedStyle(t._background).width),t._slider=null,t._tooltipTimeout=null,View.addEventListener(o.UI.Event.MOUSE_OVER,function(e){e.target===t.soundBtn&&t.open()}),View.addEventListener(o.UI.Event.MOUSE_OUT,function(){t.close()})},init:function(){if(this._container){var n=this._container.querySelector(".bolt-volume-slider");this._slider=new t(n,{vertical:!1,horizontal:!0,top:0,left:0,right:0,bottom:0,animationCallback:this._onSliderUpdate.bind(this),handleClass:"bolt-handle",css3:!1}),this.setPlayer(this.player);var i=this;if(s.browser.ie>9?this._container.addEventListener("pointerup",function(e){i._slider&&(i._slider.dragging=!1),e.stopPropagation()}):this._container.addEventListener("mouseup",function(e){i._slider&&(i._slider.dragging=!1),e.stopPropagation()}),i.soundBtn){i.soundBtn.addEventListener("mouseenter",function(e){d.isEnabled(i.soundBtn)&&("8"!==s.system.win&&"8.1"!==s.system.win||!s.browser.chrome&&!s.browser.ie?View.onMouseOver(i.soundBtn):i._mouseEnterTimeout=setTimeout(function(){View.mouseInput.isTouched||View.onMouseOver(i.soundBtn)},100))}),i.soundBtn.addEventListener("mouseleave",function(e){d.isEnabled(i.soundBtn)&&(console.log("mouse leave, audio"),e.stopPropagation(),View.onMouseOut(i.soundBtn),View.mouseInput.isTouched=!1)});var l=new e(i.soundBtn);"8"!==s.system.win&&"8.1"!==s.system.win||!s.browser.chrome&&!s.browser.ie?l.on("tap",function(e){d.isEnabled(i.soundBtn)&&View._dispatchEvent(o.UI.Event.TOGGLE_MUTE)}):l.on("hammer.input",function(e){d.isEnabled(i.soundBtn)&&("touch"===e.pointerType?"touchstart"===e.srcEvent.type||"pointerdown"===e.srcEvent.type?(View.mouseInput.isTouched=!0,i._mouseEnterTimeout&&(clearTimeout(i._mouseEnterTimeout),i._mouseEnterTimeout=null)):"touchend"!==e.srcEvent.type&&"pointerup"!==e.srcEvent.type||e.isFinal&&View._dispatchEvent(o.UI.Event.TOGGLE_MUTE):"mouseup"!==e.srcEvent.type&&"pointerup"!==e.srcEvent.type||e.isFinal&&View._dispatchEvent(o.UI.Event.TOGGLE_MUTE))})}View.addEventListener(o.UI.Event.PLAYER_CHANGED,function(){var e=o.UI;View.currentPlayer.isAd()?BoltAdManager.type===o.Ad.Type.STATIC_IMAGE||BoltAdManager.type===o.Ad.Type.THREE_TWO_FIFTY?d.enableUI(e.SOUND_BTN,!1):d.enableUI(e.SOUND_BTN,!0):View._adOnly||s.isMobile||d.enableUI(e.SOUND_BTN,!0)})}},_onVolumeChanged:function(){this._slider&&!this._slider.dragging&&this._updateHandle(),this._updateFill()},_onSliderUpdate:function(e,t){var n=this;if(n.soundBtn.setAttribute("data-zeus-tooltip","false"),View.hideTooltip(n.soundBtn),n._slider&&n._slider.dragging){i.log.info("disable volume button"),n.soundBtn.setAttribute("data-bolt-ui-enabled","false");var s=setInterval(function(){n._slider.dragging||(clearInterval(s),n.soundBtn.setAttribute("data-bolt-ui-enabled","true"))},100)}n._slider&&i.log.info("slider val",this._slider.getValue()[1]),this._dispatchEvent(o.VALUE_CHANGED,e)},_updateFill:function(){var e=this._fill,t=i.getScreenPosition(this._handle),n=i.getScreenPosition(this._handle.parentNode),o=t.x-n.x,s=this.player.muted?0:o+"px";e&&(e.style.width=s)},_updateHandle:function(){var e=this.player.muted?0:this.player.volume;this._slider.setValue(e,0,!0,!0),LOG.info("update handle",this._slider.getValue(),"volume",this.player.volume)},open:function(){var e=this,t=i.css;e.invalidate(),e.soundBtn.style.width=e._container.clientWidth+e.soundBtnWidth+"px",t.addClass(e.soundBtn,"volumeHover")},close:function(){var e=i.css;e.removeClass(this.soundBtn,"volumeHover"),this.soundBtn.setAttribute("data-zeus-tooltip","true"),this.soundBtn.style.width=this.soundBtnWidth+"px"},invalidate:function(){var e=this;e._slider.reflow(),e._updateHandle(),e._updateFill()},_onMediaMuted:function(e){i.log.info("media muted"),this._slider&&!this._slider.dragging&&this._updateHandle(),this._updateFill()},_onMediaUnmuted:function(e){i.log.info("media unmuted"),this._slider&&!this._slider.dragging&&this._updateHandle(),this._updateFill()},setPlayer:function(e){this.player=e,i.log.info("player volume",e.volume),e.addEventListener(o.Media.Event.VOLUME_CHANGED,this._onVolumeChanged.bind(this)),e.addEventListener(o.Media.Event.MUTED,this._onMediaMuted.bind(this)),e.addEventListener(o.Media.Event.UNMUTED,this._onMediaUnmuted.bind(this))}});return l});